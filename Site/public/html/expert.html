<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>MIST</title>

<!-- JQuery Style Sheets -->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.4/themes/smoothness/
jquery-ui.css">

<!-- MISTui Style Sheets -->
<link rel="stylesheet" type="text/css" href="/css/mistui-dialogs.css"></link>
<link rel="stylesheet" type="text/css" href="/css/mistui-help.css"></link>
<link rel="stylesheet" type="text/css" href="/css/mistui-menus-black.css">

<!-- Style sheet for this application -->
<link rel="stylesheet" type="text/css" href="/css/mistui-expert.css"></link>

<!-- MIST Libraries-->
<script src="/js/mist-utils.js"></script>
<script src="/js/mist-functions.js"></script>
<script src="/js/mist-layout.js"></script>
<script src="/js/mist-functions-layout.js"></script>
<script src="/js/mist-functions-builtin.js"></script>
<script src="/js/mist-render.js"></script>

<!-- MISTui Libraries -->
<script src="/js/mistui-dialogs.js"></script>
<script src="/js/mistui-help.js"></script>
<script src="/js/mistui-menus.js"></script>
<script src="/js/mistui-animator.js"></script>

<!-- JQuery Libraries -->
<script src="//code.jquery.com/jquery-1.11.1.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

<!-- Local Javascript -->
<script>
// +---------+-------------------------------------------------------
// | Globals |
// +---------+

/**
 * The current workspace.
 */
var ws;
var workspace = {};
workspace.userfuns = new MIST.Collection("User-defined functions", "Functions defined by the user.");
workspace.uservals = new MIST.Collection("User-defined values", "Values defined by the user.");

// Simulated population of the workspace
/*
workspace.userfuns.addUserFun("fun1", "fun1", "My first function", "i",
  "x+i");
workspace.userfuns.addUserFun("fun2", "fun2", "My function", "i,j",
  "x*i+y*j");
workspace.userfuns.addUserFun("myfun", "myfun", "My function", "i,j",
  "x*i+y*j");
 */
workspace.uservals.addUserVal("val1", "val1", "x*y", "x*y");
workspace.uservals.addUserVal("val2", "val2", "Almost a circle", "x*x+y*y");

/**
 * The list of selected files.
 */
var selectedFiles;

/**
 * The active animator.
 */
var animator;

// +-----------+-----------------------------------------------------
// | Functions |
// +-----------+

/**
 * Insert text into the code field.
 */
function insertText(text) {
  // Code based on
  //   http://stackoverflow.com/questions/1064089/inserting-a-text-where-cursor-is-using-javascript-jquery

  var code = document.getElementById("funcode");
  if (document.selection) {
    code.focus();
    var sel = document.selection.createRange();
    sel.text = text;
    code.focus();
  } 
  else if (code.selectionStart || code.selectionStart === 0) {
    var startPos = code.selectionStart;
    var endPos = code.selectionEnd;
    var scrollTop = code.scrollTop;
    code.value = code.value.substring(0, startPos) + text + code.value.substring(endPos, code.value.length);
    code.focus();
    code.selectionStart = startPos + text.length;
    code.selectionEnd = startPos + text.length;
    code.scrollTop = scrollTop;
  } 
  else {
    code.value += text;
    code.focus();
  }
} // insertText(txt)

/**
 * Fill in the details of the insert menu.
 */
function updateInsertMenu() {
  var makeInserter = function(txt) {
    return function(evt) {
      insertText(txt);
    };
  }; // makeInserter

  var addFunctions = function(collection)  {
    var keys = collection.keys().sort();
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var fun = collection.get(key);
      var txt = key + "(" + fun.params + ")";
      MISTui.addMenuItem("insert-menu", "insert-" + key, key,
        "<b>" + txt + "</b><br/>" + fun.about, makeInserter(txt));
    } // for
  }; // addFunctions

  var keys;
  
  // Clear the old values
  MISTui.clearMenu("insert-menu");

  // Insert the builtin functions.
  addFunctions(MIST.builtins.functions);
  MISTui.addMenuSeparator("insert-menu","insert-sep-1");

  // Insert the builtin values.

  // Insert the user functions
  addFunctions(workspace.userfuns);

  // Insert the user values


  MISTui.refreshMenu("insert-menu");
} // updateInsertMenu()

/**
 * Fill in the details of the help menu.
 */
function updateHelp() {
} // updateHelp

/**
 * Show an error on the screen.
 */
function showError(msg) {
  var info = document.getElementById("info");
  info.innerHTML = "<div class=\"error\">" + msg + "</div>";
} // showError

/**
 * Show a message on the screen.
 */
function showMessage(msg) {
  var info = document.getElementById("info");
  info.innerHTML = msg;
} // showMessage

function showInfoBox(id) {
  $("#" + id).dialog("open");
} // showInfoBox

/**
 * Confirm that we want to replace the existing function.
 */
var confirmReplaceContinuation = {};
function confirmReplaceFunction(successContinuation, failureContinuation) {
  if ((document.getElementById("funname").value) ||
      (document.getElementById("funparams").value) ||
      (document.getElementById("fundesc").value) ||
      (document.getElementById("funcode").value)) {
    confirmReplaceContinuation.success = successContinuation;
    confirmReplaceContinuation.failure = failureContinuation;
    $("#confirm-replace-function").dialog("open");
  } // confirm-replace-function
  else {
    successContinuation();
  }
} // confirmReplaceFunction

/**
 * Download something.
 *
 * Based on http://html5-demos.appspot.com/static/a.download.html
 */
function download(fname,type,content) {
  // Get our download link
  var link = document.getElementById("mist-downloader");
  if (!link) {
    link = document.createElement("a");
    link.id = "mist-downloader";
    document.body.appendChild(link);
  }

  // Set up where to download
  link.download = fname;

  // Build a blob
  var blob = new Blob([content], {type:type});

  // Build a link to the blob
  link.href = window.URL.createObjectURL(blob);

  // I think this just makes it easier to drag the link to the desktop,
  // but I could be wrong.  (Since we're not showing the link, it's
  // probably irrelevant.  But we might show the link later.)
  link.dataset.downloadurl = [type, link.download, link.href].join(':');

  // Click the link to trigger the save.
  link.click();
} // download

/**
 * Export a function, prompting for a file name.
 */
var exportFunctionContinuation = {};
function exportFunctionAs() {
  exportFunction.failure = function() { };
  exportFunction.success = function() {
    exportFunction(document.getElementById("function-filename"));
  };
  $("#export-function").dialog("open");
} // exportFunctionAs

/**
 * Export a function using a particular file name.
 */
function exportFunction(fname) {
  // Extract the fields
  var name = document.getElementById("funname").value;
  var params = document.getElementById("funparams").value;
  var about = document.getElementById("fundesc").value;
  var code = document.getElementById("funcode").value;

  // Compute the number of parameter
  nparams = params.split(",").length;
  
  // Build an appropriate object
  var fun = new MIST.FunInfo(name, name, about, params, {code:code});

  // Convert it to JSON
  var json = JSON.stringify(fun);

  // And save it
  download(fname, "text/json", json);
} // exportFunction

/**
 * Indicate that an attempt to save the current function failed.
 */
function failSaveFunction(msg) {
 document.getElementById("fail-save-message").innerHTML = msg;
 $("#fail-save-function").dialog("open");
} // failSaveFunction(msg)

/**
 * Load a function from a file.  (Maybe this should be open?)
 */
function loadFunction() {
  selectedFiles = false;
  $("#load-function-dialog").dialog("open");
}

/**
 * Open a workspace stored in a file.
 */
function openWorkspace() {
  selectedFiles = false;
  $("#open-workspace-dialog").dialog("open");
}

/**
 * Save a function to the workspace.
 */
var saveContinuation = {};
function saveFunction(success,failure) {
  // Extract the fields
  var name = document.getElementById("funname").value;
  var params = document.getElementById("funparams").value;
  var about = document.getElementById("fundesc").value;
  var code = document.getElementById("funcode").value;
  var body;

  // Set up the continuations.
  saveContinuation.failure = failure;
  saveContinuation.success = function() {
    workspace.userfuns.addUserFun(name, name, about, params, code);
    updateInsertMenu();
    success();
  };
  if (!name) {
    failSaveFunction("The function has no name.");
  }
  else if (!code) {
    failSaveFunction("The function has no code.");
  }
  else {
    try {
      var body = MIST.parse(code);
    } // try
    catch (err) {
      failSaveFunction(err);
    } // catch
    saveContinuation.success();
  }
} // saveFunction()

/**
 * Save a workspace, prompting for a file name.
 */
var saveWorkspaceContinuation = {};
function saveWorkspaceAs() {
  saveWorkspace.failure = function() { };
  saveWorkspace.success = function() {
    saveWorkspace(document.getElementById("workspace-filename"));
  };
  $("#save-workspace-dialog").dialog("open");
} // saveWorkspaceAs

/**
 * Save a workspace using a particular file name.
 */
function saveWorkspace(fname) {
  // Convert it to JSON
  var json = JSON.stringify(workspace);

  // And save it
  download(fname, "text/json", json);
} // saveWorkspace

/**
 * Start the animation running.
 */
function startAnimation() {
  var context = {};
  /*
  for (var name in workspace.userfuns.keys()) {
    context[name] = workspace.userfuns.get[name];
  } // for
   */
  if (animator) { animator.stop(); }
  animator = new MIST.ui.Animator(document.getElementById("funcode").value,
      document.getElementById("funparams").value, context,
      document.getElementById("canvas"),
      function(txt) { document.getElementById("message").value = txt; });
  animator.start();
} // startAnimation

/**
 * Stop the animation from running.
 */
function stopAnimation() {
  animator.stop();
} // stopAnimation

// +------------------+----------------------------------------------
// | Final Page Setup |
// +------------------+

$(document).ready(function() {
  // Set up the dialogs
  $("#info-about-mist").dialog({
    autoOpen: false,
    width: "50%",
    modal: true
  });

  $("#confirm-replace-function").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Save": function() {
        $(this).dialog("close");
        saveFunction(confirmReplaceContinuation.success,
                     confirmReplaceContinuation.failure);
      },
      "Replace": function() {
        $(this).dialog("close");
        confirmReplaceContinuation.success();
      },
      "Cancel": function() {
        $(this).dialog("close");
        confirmReplaceContinuation.failure();
      }
    }
  });

  $("#export-function").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Export": function() {
        $(this).dialog("close");
      },
      "Cancel": function() {
        $(this).dialog("close");
      }
    }
  });

    
  $("#fail-save-function").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Continue Without Saving": function() {
        $(this).dialog("close");
        saveContinuation.success();
      },
      "Cancel": function() {
        $(this).dialog("close");
        saveContinuation.failure();
      }
    }
  });

  $("#load-function-dialog").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Load": function() {
        $(this).dialog("close");
        if (selectedFiles) {
          var reader = new FileReader();
          reader.onload = function(evt) {
            var json = evt.target.result;
            console.log(evt.target.result);
            var fun;
            try {
              var fun = restore(JSON.parse(json));
            }
            catch (err) {
              alert("File does not contain a MIST Function");
              return;
            }
            if (fun.class != "MIST.FunInfo") {
              alert("File does not contain a MIST Function");
              return;
            }
            document.getElementById("funname").value = fun.name;
            document.getElementById("funparams").value = fun.params;
            document.getElementById("fundesc").value = fun.about;
            document.getElementById("funcode").value = fun.code;
          }; // reader.onload
          reader.readAsText(selectedFiles[0]);
        } // if (selectedFiles)
      },
      "Cancel": function() {
        $(this).dialog("close");
      }
    }
  });

  // Opening workspaces.
  $("#open-workspace-dialog").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Open": function() {
        $(this).dialog("close");
        if (selectedFiles) {
          var reader = new FileReader();
          reader.onload = function(evt) {
            var json = evt.target.result;
            var fun;
            try {
              ws = JSON.parse(json);
              restore(ws);
            }
            catch (err) {
              alert("File does not contain a workspace.");
              return;
            }
            workspace.userfuns = ws.userfuns;
            workspace.uservals = ws.uservals;
            updateInsertMenu();
          }; // reader.onload
          reader.readAsText(selectedFiles[0]);
        } // if (selectedFiles)
      },
      "Cancel": function() {
        $(this).dialog("close");
      }
    }
  });

  $("#save-workspace-dialog").dialog({
    autoOpen: false,
    resizable: false,
    width: "50%",
    modal: true,
    buttons: {
      "Export": function() {
        $(this).dialog("close");
      },
      "Cancel": function() {
        $(this).dialog("close");
      }
    }
  });

  // The MIST menu.
  MISTui.addMenu("menubar", "mist-menu", "MIST");
  MISTui.addMenuItem("mist-menu", "about-mist", "About MIST", false,
   function(event) {
     showInfoBox("info-about-mist");
   });
  MISTui.refreshMenu("mist-menu");

  // The File menu.
  MISTui.addMenu("menubar", "file-menu", "File");
  MISTui.addMenuItem("file-menu", "workspace-new", "New Workspace",
    "Create a new workspace",
    function(event) {
      alert("Not yet implemented.");
    });
  MISTui.addMenuItem("file-menu", "workspace-open", "Open Workspace...",
    "Open a workspace stored on the local filesystem",
    openWorkspace);
/*
  MISTui.addMenuItem("file-menu", "workspace-load", "Load Workspace...",
    "Load a workspace from the MIST server",
    function(event) {
      alert("Not yet implemented.");
    });
 */
  MISTui.addMenuSeparator("file-menu","file-sep-1");
  MISTui.addMenuItem("file-menu", "workspace-save", "Save Workspace",
    "Save the workspace to the local filesystem.",
    function(event) {
      saveWorkspace("mist.ws");
    });
  MISTui.addMenuItem("file-menu", "workspace-save-as", "Save Workspace As...",
    "Save the workspace to the local filesystem.",
    function(event) {
      alert("Not yet implemented");
    });
/*
  MISTui.addMenuItem("file-menu", "workspace-store", "Store Workspace",
    "Store the workspace on the MIST server.",
    function(event) {
      alert("Not yet implemented.");
    });
  MISTui.addMenuItem("file-menu", "workspace-store-as", "Store Workspace As...",
    "Store the workspace on the MIST server.",
    function(event) {
      alert("Not yet implemented.");
    });
 */
  MISTui.refreshMenu("file-menu");

  // The Function Menu
  MISTui.addMenu("menubar", "function-menu", "Function");
  MISTui.addMenuItem("function-menu", "function-new", "New Function",
    "Create a new function",
    function(event) {
      confirmReplaceFunction(
        function() {
          document.getElementById("funname").value = "";
          document.getElementById("funparams").value = "";
          document.getElementById("fundesc").value = "";
          document.getElementById("funcode").value = "";
        },
        function() {
        });
    });
  MISTui.addMenuItem("function-menu", "function-delete", "Delete Function...",
    "Delete an existing function",
    function(event) {
      alert("Not yet implemented.");
    });
  MISTui.addMenuItem("function-menu", "load-function", "Load Function ...",
    "Load a function from the local filesystem",
    function(event) {
      loadFunction();
    });
  MISTui.addMenuSeparator("function-menu","function-sep-1");
  MISTui.addMenuItem("function-menu", "function-export", "Export Function",
    "Save the function to the local filesystem",
    function(event) {
      var name = document.getElementById("funname").value;
      if (!name) { name = "untitled"; }
      exportFunction(name+".mfun");
    });
  MISTui.addMenuItem("function-menu", "function-export-as", "Export Function As...",
    "Save the function to the local filesystem",
    function(event) {
      alert("Not yet implemented.");
    });
  MISTui.addMenuSeparator("function-menu","function-sep-2");
  MISTui.addMenuItem("function-menu", "function-save", "Save Function",
    "Import this definition into the set of available functions, either adding a new function or replacing the old definition",
    function() {
      saveFunction(
        function() { },
        function() { }
      )});
  MISTui.refreshMenu("function-menu");

  // The insert menu
  MISTui.addMenu("menubar", "insert-menu", "Insert");
  updateInsertMenu();

  // Observe when we get a file
  document.getElementById("loadfun-filename").addEventListener('change',
    function(evt) {
      // Note which files are selected
      selectedFiles = evt.target.files;
      // Move the focus
      $(":button:contains('Load')").focus();
    }
  );
  document.getElementById("loadws-filename").addEventListener('change',
    function(evt) {
      // Note which files are selected
      selectedFiles = evt.target.files;
      // Move the focus
      $(":button:contains('Open')").focus();
    }
  );
});

</script>

</head>
<body>

<ul class="menubar" id="menubar"></ul>

<!--
  1. For now, I'm using some tables to do the layout.  I wish that was
  not necessary, but I can't figure out the rest.

  -->

<div width="100%">

<table width="100%">
  <tr>
    <td width="80%">

<div id="funinfo">
<table width="100%">
  <tr>
    <th width="2%">Name</th>
    <td><input class="wide" type="text" id="funname"/></td>
  </tr>
  <tr>
    <th>Parameters</th>
    <td><input class="wide" type="text" id="funparams"/></td>
  </tr>
  <tr>
    <th>Description</th>
    <td><textarea class="wide" id="fundesc" rows=4></textarea></td>
  </tr>
  <tr>
    <th>Code</th>
    <td><textarea class="wide" id="funcode" style="font-family: monospace" rows=8></textarea></td>
  </tr>
</table>
</div>

    </td>

    <td width="5%">
    </td>

    <td>

<div id="rendering">
<div style="text-align: center;">
<canvas id="canvas" width="200" height="200"></canvas>
<br/>
<input type="button" id="start" value="Start" onClick="startAnimation()"/>
<input type="button" id="stop" value="Stop" onClick="stopAnimation()"/>
</div> <!-- center -->
<script>
var canvas = document.getElementById("canvas");
var context = canvas.getContext("2d");
context.fillRect(0,0,canvas.width,canvas.height);
</script> 
<br style="clear: left;"
</div>

    </td>

    <td width="5%">
    </td>

  </tr>
</table>

</div>

<div id="info">
<script>
<!-- showBasicInfo(); -->
</script>
<textarea id="message" style="border: none;" class="message" rows="5" readonly="readonly"></textarea>
</div>

<!-- Dialog Boxes -->

<div id="confirm-replace-function" title="Replace Existing Function?">

<p>
  <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
  You are currently editing a function.  Do you want to save it first?
</p>

</div>

<div id="export-function" title="Export Function">

<form>
<fieldset>
  <label for="function-filename">File Name</label>
  <input type="text" name="function-filename" id="function-filename">
</fieldset>
</form>

</div>

<div id="fail-save-function" title="Saving failed!">

<p>
  <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>
  <span id="fail-save-message"></span>
</p>

</div>

<div id="info-about-mist" title="About MIST">
<p>
  <strong>MIST - A Mathematical Image Synthesis Toolkit</strong>
<p>

<p>
  <em>A Product of Glimmer Labs at Grinnell College</em>.
</p>

<p>
  By Eileen Fordham, Halley Freger, Amanda Hinchman Dominguez, 
  Alex Mitchell, Daniel Rebelsky, Samuel A. Rebelsky, Victoria
  Tsou, Earnest Wheeler, and Zoe Wolter
</p>

<p>
  Expert GUI by Samuel A. Rebelsky.
</p>

<p>
  Copyright &copy; 2014 Samuel A. Rebelsky.  All rights reserved.
</p>

<p>
  Source code released under GPL v3.0.
</p>

</div>

<div id="load-function-dialog" title="Load Function">

<p>
  Select the file to load.  Note that MIST functions are typically
  stored in files with a suffix of <code>.mfun</code>.
</p>

<form>
<fieldset>
  <label for="loadfun-filename">File Name</label>
  <input type="file" accept="text/json" name="loadfun-filename" id="loadfun-filename">
</fieldset>
</form>

</div>

<div id="open-workspace-dialog" title="Open Workspace">

<p>
  Select the workspace to open.
</p>

<form>
<fieldset>
  <label for="loadfun-filename">File Name</label>
  <input type="file" accept="text/json" name="loadws-filename" id="loadws-filename">
</fieldset>
</form>

</div>

<div id="save-workspace-dialog" title="Save Workspace">

<form>
<fieldset>
  <label for="workspace-filename">File Name</label>
  <input type="text" name="workspace-filename" id="workspace-filename">
</fieldset>
</form>

</div>

</body>
</html>
